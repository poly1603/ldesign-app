# NPM 源认证功能指南

## 概述

NPM 源管理现在支持多种认证方式，可以根据不同源的特性选择合适的认证方法。

## 支持的认证类型

### 1. 无需认证（只读镜像）

**适用源：**
- 淘宝镜像
- 腾讯云镜像
- 华为云镜像
- cnpm 镜像

**特点：**
- ✅ 只读访问
- ❌ 不支持发布包
- ❌ 不支持访问私有包
- ✅ 无需配置认证信息

**使用场景：**
- 加速包下载
- 国内网络环境优化
- 只需要安装公共包

---

### 2. npm 标准认证

**适用源：**
- npm 官方源
- Yarn Registry
- 自定义私有源

**认证信息：**
- 用户名（必填）
- 密码（必填）
- 邮箱（npm 官方源必填）

**特点：**
- ✅ 支持发布包
- ✅ 支持访问私有包
- ✅ 完整的 npm 功能

**使用场景：**
- 发布开源包到 npm
- 访问团队私有包
- 完整的包管理功能

**配置步骤：**

1. 选择源类型：公共源或远程私有源
2. 选择预设源或输入自定义 URL
3. 开启"认证信息"开关
4. 填写用户名、密码和邮箱
5. 点击"添加"，系统会自动登录

**认证原理：**

系统会将认证信息写入 `~/.npmrc` 文件：

```ini
//registry.npmjs.org/:_auth=base64(username:password)
//registry.npmjs.org/:username=your-username
//registry.npmjs.org/:email=your@email.com
//registry.npmjs.org/:always-auth=true
```

---

### 3. Token 认证

**适用源：**
- GitHub Package Registry
- 其他支持 Token 的私有源

**认证信息：**
- Access Token（必填）

**特点：**
- ✅ 更安全（不暴露密码）
- ✅ 细粒度权限控制
- ✅ 可随时撤销
- ✅ 支持自动化流程

**使用场景：**
- GitHub 私有包
- CI/CD 自动化
- 企业级权限管理

**GitHub Token 配置步骤：**

1. **生成 Personal Access Token**
   - 访问 GitHub Settings → Developer settings → Personal access tokens
   - 点击 "Generate new token (classic)"
   - 选择权限：
     - ✅ `read:packages` - 读取包
     - ✅ `write:packages` - 发布包
     - ✅ `delete:packages` - 删除包（可选）
   - 生成并复制 Token

2. **在应用中配置**
   - 选择"公共源"
   - 选择"GitHub Package Registry"
   - 开启"认证信息"开关
   - 粘贴 Token
   - 点击"添加"

**认证原理：**

系统会将 Token 写入 `~/.npmrc` 文件：

```ini
//npm.pkg.github.com/:_authToken=ghp_xxxxxxxxxxxx
//npm.pkg.github.com/:always-auth=true
```

---

## 功能特性

### 智能认证提示

根据选择的源，系统会自动显示相应的认证说明：

- **只读镜像**：提示不支持认证
- **npm 官方源**：说明需要邮箱
- **GitHub**：提示需要 Token 权限

### 自动登录

添加源时，如果提供了认证信息，系统会：

1. 保存源配置
2. 自动执行登录
3. 显示登录结果
4. 如果失败，提示手动登录

### 用户包过滤

登录后，包列表会优先显示：

- **npm 认证**：显示该用户发布的包
- **Token 认证**：显示已认证可访问的包
- **无认证**：显示所有公开包

### 认证状态显示

在源列表和包列表中，会显示：

- 👤 用户名（npm 认证）
- 🔑 Token 认证状态
- ✅ 登录成功标识

---

## 使用示例

### 示例 1：添加 npm 官方源并登录

```
1. 点击"添加源"
2. 选择"公共源"
3. 选择"npm 官方源"
4. 开启"认证信息"
5. 填写：
   - 用户名: your-username
   - 密码: your-password
   - 邮箱: your@email.com
6. 点击"添加"
7. 等待自动登录完成
```

**结果：**
- ✅ 源添加成功
- ✅ 自动登录成功
- ✅ 可以发布包
- ✅ 可以访问私有包

---

### 示例 2：添加 GitHub Package Registry

```
1. 在 GitHub 生成 Token（需要 read:packages 权限）
2. 点击"添加源"
3. 选择"公共源"
4. 选择"GitHub Package Registry"
5. 开启"认证信息"
6. 粘贴 Token
7. 点击"添加"
```

**结果：**
- ✅ 源添加成功
- ✅ Token 认证配置完成
- ✅ 可以访问 GitHub 私有包
- ✅ 可以发布到 GitHub Packages

---

### 示例 3：添加淘宝镜像（无需认证）

```
1. 点击"添加源"
2. 选择"公共源"
3. 选择"淘宝镜像"
4. 直接点击"添加"（无需开启认证）
```

**结果：**
- ✅ 源添加成功
- ✅ 可以快速下载包
- ❌ 不能发布包
- ❌ 不能访问私有包

---

### 示例 4：添加企业私有源

```
1. 点击"添加源"
2. 选择"远程私有源"
3. 填写：
   - 源名称: 公司私有源
   - 源地址: https://npm.company.com/
4. 开启"认证信息"（私有源建议开启）
5. 填写公司提供的用户名和密码
6. 点击"添加"
```

**结果：**
- ✅ 源添加成功
- ✅ 自动登录成功
- ✅ 可以访问公司私有包
- ✅ 可以发布到公司私有源

---

## 安全建议

### 1. Token 管理

- ✅ 使用 Token 而不是密码（更安全）
- ✅ 定期轮换 Token
- ✅ 为不同用途创建不同 Token
- ✅ 及时撤销不用的 Token
- ❌ 不要在公共场所展示 Token

### 2. 密码安全

- ✅ 使用强密码
- ✅ 不要在多个服务使用相同密码
- ✅ 启用两步验证（如果支持）
- ❌ 不要分享账号密码

### 3. 权限控制

- ✅ 只授予必要的权限
- ✅ 定期审查权限
- ✅ 使用组织账号管理团队包
- ❌ 不要使用个人账号管理企业包

---

## 故障排除

### 登录失败

**可能原因：**
1. 用户名或密码错误
2. Token 已过期或被撤销
3. 网络连接问题
4. 源不支持该认证方式

**解决方法：**
1. 检查认证信息是否正确
2. 重新生成 Token
3. 检查网络连接
4. 查看源的认证说明
5. 使用"重新登录"功能

### 无法访问私有包

**可能原因：**
1. 未登录或登录失效
2. 权限不足
3. 包不存在

**解决方法：**
1. 重新登录
2. 检查账号权限
3. 确认包名和版本

### Token 认证不生效

**可能原因：**
1. Token 权限不足
2. Token 格式错误
3. 源不支持 Token 认证

**解决方法：**
1. 检查 Token 权限（需要 read:packages）
2. 确认 Token 完整复制
3. 查看源的认证文档

---

## 技术细节

### 认证信息存储

所有认证信息都存储在：
- **配置文件**：`~/.flutter_toolbox/npm_registries.json`
- **npm 配置**：`~/.npmrc`

### 认证流程

```
1. 用户填写认证信息
   ↓
2. 保存到配置文件
   ↓
3. 写入 ~/.npmrc
   ↓
4. 测试连接
   ↓
5. 显示结果
```

### Token vs 密码

| 特性 | Token | 密码 |
|------|-------|------|
| 安全性 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| 权限控制 | ✅ 细粒度 | ❌ 全部权限 |
| 可撤销性 | ✅ 随时撤销 | ❌ 需要改密码 |
| 过期时间 | ✅ 可设置 | ❌ 永久有效 |
| 适用场景 | CI/CD, 自动化 | 手动操作 |

---

## 最佳实践

### 开发环境

```
推荐配置：
1. npm 官方源（带认证）- 发布开源包
2. 淘宝镜像（无认证）- 快速下载
3. 公司私有源（带认证）- 访问私有包
```

### CI/CD 环境

```
推荐配置：
1. 使用 Token 认证
2. 将 Token 存储在环境变量
3. 不要提交 Token 到代码仓库
4. 定期轮换 Token
```

### 团队协作

```
推荐配置：
1. 使用组织账号
2. 统一的私有源配置
3. 文档化认证流程
4. 定期审查权限
```

---

## 总结

通过灵活的认证系统，你可以：

- ✅ 安全地管理多个 npm 源
- ✅ 根据需求选择合适的认证方式
- ✅ 自动化登录流程
- ✅ 保护敏感信息
- ✅ 提高开发效率

选择合适的认证方式，让包管理更安全、更高效！
