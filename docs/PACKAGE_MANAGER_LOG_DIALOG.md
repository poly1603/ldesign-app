# åŒ…ç®¡ç†å™¨å®‰è£…/æ›´æ–°æ—¥å¿—å¯¹è¯æ¡†

## åŠŸèƒ½æ¦‚è¿°

ä¸ºåŒ…ç®¡ç†å™¨çš„å®‰è£…å’Œæ›´æ–°æ“ä½œæ·»åŠ äº†è¯¦ç»†çš„æ—¥å¿—å¯¹è¯æ¡†ï¼Œè®©ç”¨æˆ·å¯ä»¥å®æ—¶æŸ¥çœ‹æ“ä½œè¿›åº¦å’Œè¯¦ç»†ä¿¡æ¯ã€‚

## ä¸»è¦æ”¹è¿›

### 1. å¼ºåˆ¶æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬

**ä¹‹å‰çš„é—®é¢˜ï¼š**
```bash
npm update -g pnpm
# å¯èƒ½ä¸ä¼šæ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
```

**ç°åœ¨çš„è§£å†³æ–¹æ¡ˆï¼š**
```bash
# 1. å…ˆè·å–æœ€æ–°ç‰ˆæœ¬å·
npm view pnpm version
# è¾“å‡º: 10.0.0

# 2. å¼ºåˆ¶å®‰è£…æœ€æ–°ç‰ˆæœ¬
npm install -g pnpm@10.0.0
# ç¡®ä¿å®‰è£…æœ€æ–°ç‰ˆæœ¬
```

### 2. å®æ—¶æ—¥å¿—æ˜¾ç¤º

ç”¨æˆ·ç°åœ¨å¯ä»¥çœ‹åˆ°å®Œæ•´çš„å®‰è£…/æ›´æ–°è¿‡ç¨‹ï¼š

```
[14:23:45] å¼€å§‹æ›´æ–° pnpm...
[14:23:45] è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯...
[14:23:46] æœ€æ–°ç‰ˆæœ¬: 10.0.0
[14:23:46] æ­£åœ¨å®‰è£… pnpm@10.0.0...
[14:23:47] 
[14:23:48] changed 1 package in 2s
[14:23:48] 
[14:23:48] 1 package is looking for funding
[14:23:48]   run `npm fund` for details
[14:23:48] âœ… pnpm æ›´æ–°æˆåŠŸåˆ° v10.0.0
```

### 3. è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

å¦‚æœæ›´æ–°å¤±è´¥ï¼Œä¼šæ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼š

```
[14:23:45] å¼€å§‹æ›´æ–° yarn...
[14:23:46] è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯...
[14:23:47] æœ€æ–°ç‰ˆæœ¬: 1.22.23
[14:23:47] æ­£åœ¨å®‰è£… yarn@1.22.23...
[14:23:48] é”™è¯¯: npm ERR! network timeout
[14:23:48] âŒ yarn æ›´æ–°å¤±è´¥
```

## UI è®¾è®¡

### æ—¥å¿—å¯¹è¯æ¡†å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â³ æ›´æ–° pnpm                          âŸ³    â”‚  â† æ ‡é¢˜ + è¿›åº¦æŒ‡ç¤ºå™¨
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ [14:23:45] å¼€å§‹æ›´æ–° pnpm...          â”‚ â”‚
â”‚  â”‚ [14:23:45] è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯...       â”‚ â”‚
â”‚  â”‚ [14:23:46] æœ€æ–°ç‰ˆæœ¬: 10.0.0         â”‚ â”‚  â† æ—¥å¿—åŒºåŸŸ
â”‚  â”‚ [14:23:46] æ­£åœ¨å®‰è£… pnpm@10.0.0...  â”‚ â”‚    (é»‘è‰²èƒŒæ™¯)
â”‚  â”‚ [14:23:48] âœ… pnpm æ›´æ–°æˆåŠŸ         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                             â”‚
â”‚                              [å®Œæˆ] â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â† æ“ä½œæŒ‰é’®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çŠ¶æ€æŒ‡ç¤º

1. **è¿›è¡Œä¸­**
   - å›¾æ ‡ï¼šâ³ (æ²™æ¼)
   - é¢œè‰²ï¼šæ©™è‰²
   - å³ä¸Šè§’ï¼šæ—‹è½¬çš„è¿›åº¦æŒ‡ç¤ºå™¨
   - æŒ‰é’®ï¼šç¦ç”¨çŠ¶æ€ "è¯·ç­‰å¾…..."

2. **æˆåŠŸ**
   - å›¾æ ‡ï¼šâœ… (å¯¹å‹¾)
   - é¢œè‰²ï¼šç»¿è‰²
   - æŒ‰é’®ï¼šå¯ç”¨ "å®Œæˆ"

3. **å¤±è´¥**
   - å›¾æ ‡ï¼šâŒ (é”™è¯¯)
   - é¢œè‰²ï¼šçº¢è‰²
   - æŒ‰é’®ï¼šå¯ç”¨ "å®Œæˆ"

### æ—¥å¿—é¢œè‰²ç¼–ç 

- ğŸŸ¢ **ç»¿è‰²** - æˆåŠŸæ¶ˆæ¯ (åŒ…å« âœ…)
- ğŸ”´ **çº¢è‰²** - é”™è¯¯æ¶ˆæ¯ (åŒ…å« âŒ)
- ğŸŸ  **æ©™è‰²** - è­¦å‘Šæ¶ˆæ¯ (åŒ…å« "è­¦å‘Š")
- âšª **æµ…ç»¿è‰²** - æ™®é€šæ—¥å¿—

## æŠ€æœ¯å®ç°

### 1. æœåŠ¡å±‚æ”¹è¿›

```dart
/// æ›´æ–°åŒ…ç®¡ç†å™¨ï¼ˆå¼ºåˆ¶å®‰è£…æœ€æ–°ç‰ˆæœ¬ï¼‰
Future<bool> updatePackageManager(String name, Function(String) onLog) async {
  onLog('å¼€å§‹æ›´æ–° $name...');
  
  // 1. è·å–æœ€æ–°ç‰ˆæœ¬
  final versionResult = await Process.run('npm', ['view', name, 'version'], runInShell: true);
  final latestVersion = versionResult.stdout.toString().trim();
  onLog('æœ€æ–°ç‰ˆæœ¬: $latestVersion');
  
  // 2. å¼ºåˆ¶å®‰è£…æœ€æ–°ç‰ˆæœ¬
  onLog('æ­£åœ¨å®‰è£… $name@$latestVersion...');
  final result = await Process.run(
    'npm',
    ['install', '-g', '$name@$latestVersion'],
    runInShell: true,
  );
  
  // 3. è¾“å‡ºæ—¥å¿—
  onLog(result.stdout.toString());
  if (result.stderr.toString().isNotEmpty) {
    onLog('è­¦å‘Š: ${result.stderr}');
  }
  
  // 4. è¿”å›ç»“æœ
  if (result.exitCode == 0) {
    onLog('âœ… $name æ›´æ–°æˆåŠŸåˆ° v$latestVersion');
    return true;
  } else {
    onLog('âŒ $name æ›´æ–°å¤±è´¥');
    return false;
  }
}
```

### 2. UI å±‚å®ç°

ä½¿ç”¨ `StatefulBuilder` å®ç°å®æ—¶æ›´æ–°ï¼š

```dart
await showDialog(
  context: context,
  barrierDismissible: false,
  builder: (dialogContext) {
    return StatefulBuilder(
      builder: (context, setState) {
        // åœ¨ Future.microtask ä¸­æ‰§è¡Œå¼‚æ­¥æ“ä½œ
        if (logs.isEmpty && !isCompleted) {
          Future.microtask(() async {
            final service = NodeMigrationService();
            
            // æ·»åŠ æ—¥å¿—çš„å›è°ƒ
            void addLog(String log) {
              setState(() {
                logs.add('[${DateTime.now()}] $log');
              });
            }

            // æ‰§è¡Œæ“ä½œ
            final success = await service.updatePackageManager(name, addLog);
            
            setState(() {
              isCompleted = true;
              isSuccess = success;
            });
          });
        }

        return Dialog(...);
      },
    );
  },
);
```

### 3. æ—¥å¿—æ ¼å¼åŒ–

æ¯æ¡æ—¥å¿—éƒ½å¸¦æœ‰æ—¶é—´æˆ³ï¼š

```dart
void addLog(String log) {
  setState(() {
    logs.add('[${DateTime.now().toString().substring(11, 19)}] $log');
  });
}
```

è¾“å‡ºæ ¼å¼ï¼š`[HH:MM:SS] æ—¥å¿—å†…å®¹`

## ç”¨æˆ·ä½“éªŒæ”¹è¿›

### ä¹‹å‰
- âŒ åªæ˜¾ç¤ºç®€å•çš„åŠ è½½åŠ¨ç”»
- âŒ çœ‹ä¸åˆ°æ›´æ–°è¿›åº¦
- âŒ ä¸çŸ¥é“æ˜¯å¦çœŸçš„åœ¨æ›´æ–°
- âŒ æ›´æ–°å¤±è´¥ä¸çŸ¥é“åŸå› 
- âŒ æ›´æ–°åç‰ˆæœ¬å·å¯èƒ½ä¸å˜

### ç°åœ¨
- âœ… æ˜¾ç¤ºè¯¦ç»†çš„æ“ä½œæ—¥å¿—
- âœ… å®æ—¶æŸ¥çœ‹æ›´æ–°è¿›åº¦
- âœ… æ¸…æ¥šçŸ¥é“æ¯ä¸€æ­¥åœ¨åšä»€ä¹ˆ
- âœ… å¤±è´¥æ—¶æ˜¾ç¤ºè¯¦ç»†é”™è¯¯
- âœ… å¼ºåˆ¶æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬

## æ“ä½œæµç¨‹

### æ›´æ–°åŒ…ç®¡ç†å™¨

```
1. ç”¨æˆ·ç‚¹å‡» pnpm å¡ç‰‡
   â†“
2. æ£€æµ‹åˆ°æœ‰æ›´æ–°å¯ç”¨
   â†“
3. æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼š"ç¡®å®šè¦æ›´æ–° pnpm å—ï¼Ÿ"
   â†“
4. ç”¨æˆ·ç‚¹å‡»"ç¡®å®š"
   â†“
5. æ˜¾ç¤ºæ—¥å¿—å¯¹è¯æ¡†
   â”œâ”€ [14:23:45] å¼€å§‹æ›´æ–° pnpm...
   â”œâ”€ [14:23:45] è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯...
   â”œâ”€ [14:23:46] æœ€æ–°ç‰ˆæœ¬: 10.0.0
   â”œâ”€ [14:23:46] æ­£åœ¨å®‰è£… pnpm@10.0.0...
   â”œâ”€ [14:23:48] changed 1 package in 2s
   â””â”€ [14:23:48] âœ… pnpm æ›´æ–°æˆåŠŸåˆ° v10.0.0
   â†“
6. ç”¨æˆ·ç‚¹å‡»"å®Œæˆ"
   â†“
7. é¡µé¢è‡ªåŠ¨åˆ·æ–°ï¼Œæ˜¾ç¤ºæ–°ç‰ˆæœ¬ v10.0.0
   â†“
8. pnpm å¡ç‰‡æ˜¾ç¤º "âœ“ æœ€æ–°ç‰ˆæœ¬"
```

### å®‰è£…åŒ…ç®¡ç†å™¨

```
1. ç”¨æˆ·ç‚¹å‡» yarn å¡ç‰‡ï¼ˆæœªå®‰è£…ï¼‰
   â†“
2. æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼š"ç¡®å®šè¦å®‰è£… yarn å—ï¼Ÿ"
   â†“
3. ç”¨æˆ·ç‚¹å‡»"ç¡®å®š"
   â†“
4. æ˜¾ç¤ºæ—¥å¿—å¯¹è¯æ¡†
   â”œâ”€ [14:25:10] å¼€å§‹å®‰è£… yarn...
   â”œâ”€ [14:25:12] added 1 package in 2s
   â””â”€ [14:25:12] âœ… yarn å®‰è£…æˆåŠŸ
   â†“
5. ç”¨æˆ·ç‚¹å‡»"å®Œæˆ"
   â†“
6. é¡µé¢è‡ªåŠ¨åˆ·æ–°ï¼Œæ˜¾ç¤º yarn v1.22.22
```

## é”™è¯¯å¤„ç†

### ç½‘ç»œé”™è¯¯

```
[14:23:45] å¼€å§‹æ›´æ–° pnpm...
[14:23:45] è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯...
[14:23:50] é”™è¯¯: npm ERR! network timeout
[14:23:50] âŒ æ›´æ–°å¤±è´¥: ProcessException: ...
```

### æƒé™é”™è¯¯

```
[14:23:45] å¼€å§‹å®‰è£… yarn...
[14:23:46] é”™è¯¯: npm ERR! EACCES: permission denied
[14:23:46] âŒ yarn å®‰è£…å¤±è´¥
```

ç”¨æˆ·å¯ä»¥çœ‹åˆ°å…·ä½“çš„é”™è¯¯ä¿¡æ¯ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜ã€‚

## æ€§èƒ½ä¼˜åŒ–

1. **å¼‚æ­¥æ‰§è¡Œ**ï¼šä½¿ç”¨ `Future.microtask` é¿å…é˜»å¡ UI
2. **å®æ—¶æ›´æ–°**ï¼šä½¿ç”¨ `StatefulBuilder` å®æ—¶æ›´æ–°æ—¥å¿—
3. **è‡ªåŠ¨åˆ·æ–°**ï¼šæ“ä½œå®Œæˆåè‡ªåŠ¨åˆ·æ–°ç¯å¢ƒä¿¡æ¯

## æœªæ¥æ”¹è¿›

1. **æ—¥å¿—å¯¼å‡º**ï¼šå…è®¸ç”¨æˆ·å¯¼å‡ºæ—¥å¿—åˆ°æ–‡ä»¶
2. **è¿›åº¦ç™¾åˆ†æ¯”**ï¼šæ˜¾ç¤ºæ›´ç²¾ç¡®çš„è¿›åº¦
3. **å–æ¶ˆæ“ä½œ**ï¼šå…è®¸ç”¨æˆ·å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„æ“ä½œ
4. **æ‰¹é‡æ“ä½œ**ï¼šåŒæ—¶æ›´æ–°å¤šä¸ªåŒ…ç®¡ç†å™¨

---

**åŠŸèƒ½å®Œæˆï¼** âœ…

ç°åœ¨ç”¨æˆ·å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°åŒ…ç®¡ç†å™¨çš„å®‰è£…å’Œæ›´æ–°è¿‡ç¨‹ï¼Œä¸å†æ˜¯é»‘ç›’æ“ä½œã€‚
