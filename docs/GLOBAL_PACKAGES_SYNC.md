# 全局包自动同步功能

## 问题背景

### 为什么切换 Node 版本后全局包会消失？

当使用 nvm、fnm、volta 等版本管理工具时，**每个 Node 版本都有独立的全局包目录**。

#### 目录结构示例（nvm）

```
C:\Users\用户名\AppData\Roaming\nvm\
├── v20.19.5\
│   └── node_modules\          ← 20.19.5 的全局包
│       ├── pnpm\
│       ├── yarn\
│       └── typescript\
├── v22.21.1\
│   └── node_modules\          ← 22.21.1 的全局包（空的）
└── v18.17.0\
    └── node_modules\          ← 18.17.0 的全局包（空的）
```

#### 为什么要这样设计？

1. **隔离性** - 避免不同版本之间的包冲突
2. **兼容性** - 不同 Node 版本可能需要不同版本的包
3. **稳定性** - 防止包版本不兼容导致的问题

### 用户痛点

```
场景：
1. 在 Node v20.19.5 安装了 pnpm 和 yarn
2. 切换到 Node v22.21.1
3. 发现 pnpm 和 yarn 都不见了 ❌
4. 需要手动重新安装 😫
```

## 解决方案

### 功能：自动同步全局包

在切换 Node 版本时，提供选项自动将当前版本的全局包安装到新版本。

### 工作流程

```
1. 用户点击切换版本
   ↓
2. 显示确认对话框
   ├─ 提示：每个版本有独立的全局包目录
   └─ 选项：☑ 自动同步全局包（默认勾选）
   ↓
3. 用户确认
   ↓
4. 获取当前版本的全局包列表
   ├─ pnpm
   ├─ yarn
   └─ typescript
   ↓
5. 执行版本切换
   ↓
6. 显示同步进度对话框
   ├─ [1/3] 正在安装 pnpm...
   ├─ ✅ pnpm 安装成功
   ├─ [2/3] 正在安装 yarn...
   ├─ ✅ yarn 安装成功
   ├─ [3/3] 正在安装 typescript...
   └─ ✅ typescript 安装成功
   ↓
7. 同步完成
   └─ 显示：✅ 版本切换完成！成功同步 3 个全局包
```

## 功能特性

### 1. 智能过滤

自动过滤不需要同步的包：
- ❌ `npm` - Node 内置，不需要安装
- ❌ `corepack` - Node 内置工具
- ✅ `pnpm` - 用户安装的包
- ✅ `yarn` - 用户安装的包
- ✅ `typescript` - 用户安装的包

### 2. 实时进度

显示详细的安装进度和日志：

```
[14:23:45] 开始同步 3 个全局包...
[14:23:45] [1/3] 正在安装 pnpm...
[14:23:46] npm install -g pnpm
[14:23:50] ✅ pnpm 安装成功
[14:23:50] [2/3] 正在安装 yarn...
[14:23:51] npm install -g yarn
[14:23:55] ✅ yarn 安装成功
[14:23:55] [3/3] 正在安装 typescript...
[14:23:56] npm install -g typescript
[14:24:00] ✅ typescript 安装成功
[14:24:00] 
[14:24:00] 同步完成！成功: 3, 失败: 0
```

### 3. 错误处理

如果某个包安装失败，继续安装其他包：

```
[14:23:45] [1/3] 正在安装 pnpm...
[14:23:50] ✅ pnpm 安装成功
[14:23:50] [2/3] 正在安装 some-broken-package...
[14:23:55] ❌ some-broken-package 安装失败
[14:23:55] [3/3] 正在安装 yarn...
[14:24:00] ✅ yarn 安装成功

同步完成！成功: 2, 失败: 1
```

### 4. 可选功能

用户可以选择是否同步：
- ✅ 勾选 - 自动同步全局包
- ❌ 不勾选 - 只切换版本，不同步包

## UI 设计

### 切换确认对话框

```
┌─────────────────────────────────────┐
│ 切换 Node 版本                       │
├─────────────────────────────────────┤
│ 确定要切换到 v22.21.1 吗？           │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ ℹ️ 提示                          │ │
│ │ 每个 Node 版本都有独立的全局包   │ │
│ │ 目录。切换版本后需要重新安装     │ │
│ │ 全局包。                         │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ☑ 自动同步全局包                    │
│   将当前版本的全局包安装到新版本     │
│                                     │
├─────────────────────────────────────┤
│              [取消]  [确定]          │
└─────────────────────────────────────┘
```

### 同步进度对话框

```
┌─────────────────────────────────────┐
│ 🔄 同步全局包              ⏳       │
├─────────────────────────────────────┤
│ ┌─────────────────────────────────┐ │
│ │ [14:23:45] 开始同步 3 个全局包  │ │
│ │ [14:23:45] [1/3] 正在安装 pnpm │ │
│ │ [14:23:50] ✅ pnpm 安装成功     │ │
│ │ [14:23:50] [2/3] 正在安装 yarn │ │
│ │ [14:23:55] ✅ yarn 安装成功     │ │
│ │ [14:23:55] [3/3] 正在安装 ts   │ │
│ │ [14:24:00] ✅ typescript 成功   │ │
│ │                                 │ │
│ │ [14:24:00] 同步完成！           │ │
│ │ 成功: 3, 失败: 0                │ │
│ └─────────────────────────────────┘ │
├─────────────────────────────────────┤
│                        [同步中...]   │
└─────────────────────────────────────┘
```

## 技术实现

### 1. 获取当前全局包列表

```dart
List<String>? packagesToSync;
if (syncGlobalPackages) {
  final currentPackages = await service.getGlobalPackages();
  // 过滤掉 npm 和 corepack
  packagesToSync = currentPackages
      .where((pkg) => pkg.name != 'npm' && pkg.name != 'corepack')
      .map((pkg) => pkg.name)
      .toList();
}
```

### 2. 切换版本

```dart
final success = await service.switchNodeVersion(
  currentTool,
  version,
  (log) => debugPrint(log),
);
```

### 3. 同步全局包

```dart
for (int i = 0; i < packages.length; i++) {
  final packageName = packages[i];
  addLog('[${ i + 1}/${packages.length}] 正在安装 $packageName...');
  
  final success = await service.installPackageManager(packageName, (log) {
    addLog(log);
  });
  
  if (success) {
    successCount++;
    addLog('✅ $packageName 安装成功');
  } else {
    failedCount++;
    addLog('❌ $packageName 安装失败');
  }
}
```

### 4. 刷新环境信息

```dart
// 同步完成后刷新
await Future.delayed(const Duration(milliseconds: 500));
ref.read(nodeEnvironmentProvider.notifier).refresh();
```

## 使用场景

### 场景 1: 开发环境切换

```
开发者在不同项目间切换：
- 项目 A 使用 Node v18 + pnpm
- 项目 B 使用 Node v20 + yarn

切换时自动同步全局包，无需手动安装。
```

### 场景 2: 版本升级

```
升级 Node 版本：
- 从 v20.19.5 升级到 v22.21.1
- 自动同步所有全局工具
- 保持开发环境一致
```

### 场景 3: 团队协作

```
团队成员使用相同的全局工具：
- pnpm
- typescript
- eslint
- prettier

切换版本时自动同步，保持团队一致性。
```

## 优势对比

### 之前的体验 ❌

```
1. 切换到新版本
2. 运行 pnpm 命令
3. 提示：'pnpm' 不是内部或外部命令
4. 手动安装：npm install -g pnpm
5. 手动安装：npm install -g yarn
6. 手动安装：npm install -g typescript
7. ...（重复 N 次）
```

**问题**：
- 😫 需要记住安装了哪些全局包
- 😫 需要手动逐个安装
- 😫 容易遗漏某些包
- 😫 浪费时间

### 现在的体验 ✅

```
1. 切换到新版本
2. 勾选"自动同步全局包"
3. 点击确定
4. 等待自动安装完成
5. 完成！所有全局包都可用
```

**优势**：
- ✅ 自动识别全局包
- ✅ 一键同步所有包
- ✅ 实时显示进度
- ✅ 节省时间

## 注意事项

### 1. 网络要求

同步全局包需要从 npm registry 下载，确保网络连接正常。

### 2. 时间消耗

同步时间取决于：
- 全局包数量
- 网络速度
- 包的大小

通常需要 1-3 分钟。

### 3. 版本兼容性

某些包可能在不同 Node 版本上有兼容性问题。如果安装失败：
- 查看日志了解原因
- 手动安装兼容版本

### 4. 可选功能

如果不需要同步，可以取消勾选：
- 适合只是临时切换版本
- 适合新版本只用于测试

## 总结

### 解决的问题

✅ 切换版本后全局包消失  
✅ 需要手动重新安装  
✅ 容易遗漏某些包  
✅ 浪费时间和精力  

### 提供的价值

⚡ 自动化 - 一键同步所有全局包  
📊 可视化 - 实时显示安装进度  
🛡️ 可靠性 - 错误处理和日志记录  
⚙️ 灵活性 - 可选择是否同步  

### 用户体验

从"手动安装 N 次"到"一键自动同步"，大幅提升开发效率！

---

**现在切换 Node 版本，再也不用担心全局包丢失了！** 🎉
