# Node ç‰ˆæœ¬åˆ‡æ¢ä¼˜åŒ–

## ä¼˜åŒ–å†…å®¹

å°† Node ç‰ˆæœ¬åˆ‡æ¢ä»"åˆ·æ–°æ•´ä¸ªé¡µé¢"ä¼˜åŒ–ä¸º"åªæ›´æ–°å½“å‰ç‰ˆæœ¬ä¿¡æ¯"ã€‚

## é—®é¢˜

ä¹‹å‰çš„å®ç°ï¼š
```dart
if (success) {
  // åˆ·æ–°æ•´ä¸ªç¯å¢ƒä¿¡æ¯ - ä¼šé‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
  ref.read(nodeEnvironmentProvider.notifier).refresh();
  
  ScaffoldMessenger.of(context).showSnackBar(
    SnackBar(content: Text('å·²åˆ‡æ¢åˆ° v$version')),
  );
}
```

**ç¼ºç‚¹**ï¼š
- âŒ åˆ·æ–°æ•´ä¸ªé¡µé¢ï¼Œç”¨æˆ·ä½“éªŒä¸å¥½
- âŒ é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®ï¼ˆç‰ˆæœ¬åˆ—è¡¨ã€å…¨å±€åŒ…ç­‰ï¼‰ï¼Œæµªè´¹èµ„æº
- âŒ é¡µé¢ä¼šé—ªçƒï¼Œæ˜¾ç¤º loading çŠ¶æ€
- âŒ åˆ‡æ¢é€Ÿåº¦æ…¢

## è§£å†³æ–¹æ¡ˆ

### 1. åœ¨ Provider ä¸­æ·»åŠ  `updateCurrentVersion` æ–¹æ³•

```dart
/// æ›´æ–°å½“å‰ Node ç‰ˆæœ¬ï¼ˆä¸åˆ·æ–°æ•´ä¸ªç¯å¢ƒï¼‰
void updateCurrentVersion(String newVersion) {
  state.whenData((env) {
    // æ›´æ–°å·²å®‰è£…ç‰ˆæœ¬çš„æ¿€æ´»çŠ¶æ€
    final updatedVersions = env.installedVersions.map((v) {
      return NodeVersion(
        version: v.version,
        path: v.path,
        isActive: v.version == newVersion,  // æ›´æ–°æ¿€æ´»çŠ¶æ€
        source: v.source,
      );
    }).toList();

    // ä½¿ç”¨ copyWith åˆ›å»ºæ–°çš„ç¯å¢ƒå¯¹è±¡
    final updatedEnv = env.copyWith(
      nodeVersion: newVersion,              // æ›´æ–°å½“å‰ç‰ˆæœ¬
      installedVersions: updatedVersions,   // æ›´æ–°ç‰ˆæœ¬åˆ—è¡¨
    );

    if (mounted) {
      state = AsyncValue.data(updatedEnv);
    }
  });
}
```

### 2. åœ¨åˆ‡æ¢ç‰ˆæœ¬æ—¶è°ƒç”¨æ–°æ–¹æ³•

```dart
if (success) {
  // åªæ›´æ–°å½“å‰ç‰ˆæœ¬ï¼Œä¸åˆ·æ–°æ•´ä¸ªé¡µé¢
  ref.read(nodeEnvironmentProvider.notifier).updateCurrentVersion(version);

  ScaffoldMessenger.of(context).showSnackBar(
    SnackBar(
      content: Text('âœ… å·²åˆ‡æ¢åˆ° v$version'),
      duration: const Duration(seconds: 2),
    ),
  );
}
```

## ä¼˜åŒ–æ•ˆæœ

### ä¹‹å‰çš„æµç¨‹
```
ç‚¹å‡»ç‰ˆæœ¬ â†’ æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡† â†’ æ˜¾ç¤º"æ­£åœ¨åˆ‡æ¢..."å¯¹è¯æ¡† 
â†’ æ‰§è¡Œåˆ‡æ¢å‘½ä»¤ â†’ å…³é—­å¯¹è¯æ¡† â†’ åˆ·æ–°æ•´ä¸ªé¡µé¢ï¼ˆloadingï¼‰
â†’ é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ® â†’ æ˜¾ç¤ºæˆåŠŸæç¤º
```

**è€—æ—¶**: çº¦ 2-3 ç§’

### ä¼˜åŒ–åçš„æµç¨‹
```
ç‚¹å‡»ç‰ˆæœ¬ â†’ æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡† â†’ æ˜¾ç¤º"æ­£åœ¨åˆ‡æ¢..."å¯¹è¯æ¡† 
â†’ æ‰§è¡Œåˆ‡æ¢å‘½ä»¤ â†’ å…³é—­å¯¹è¯æ¡† â†’ æ›´æ–°å½“å‰ç‰ˆæœ¬ï¼ˆå³æ—¶ï¼‰
â†’ æ˜¾ç¤ºæˆåŠŸæç¤º
```

**è€—æ—¶**: çº¦ 1 ç§’

## æŠ€æœ¯ç»†èŠ‚

### 1. çŠ¶æ€æ›´æ–°ç­–ç•¥

ä½¿ç”¨ `state.whenData()` ç¡®ä¿åªåœ¨æœ‰æ•°æ®æ—¶æ›´æ–°ï¼š

```dart
state.whenData((env) {
  // åªæœ‰åœ¨ state æ˜¯ AsyncValue.data æ—¶æ‰æ‰§è¡Œ
  final updatedEnv = env.copyWith(...);
  state = AsyncValue.data(updatedEnv);
});
```

### 2. ä¸å¯å˜æ•°æ®æ›´æ–°

ä½¿ç”¨ `copyWith` åˆ›å»ºæ–°å¯¹è±¡ï¼Œä¿æŒæ•°æ®ä¸å¯å˜æ€§ï¼š

```dart
final updatedEnv = env.copyWith(
  nodeVersion: newVersion,
  installedVersions: updatedVersions,
);
```

### 3. ç‰ˆæœ¬æ¿€æ´»çŠ¶æ€åŒæ­¥

æ›´æ–°ç‰ˆæœ¬åˆ—è¡¨ä¸­çš„æ¿€æ´»çŠ¶æ€ï¼Œç¡®ä¿ UI æ­£ç¡®æ˜¾ç¤ºï¼š

```dart
final updatedVersions = env.installedVersions.map((v) {
  return NodeVersion(
    version: v.version,
    path: v.path,
    isActive: v.version == newVersion,  // åªæœ‰å½“å‰ç‰ˆæœ¬ä¸º true
    source: v.source,
  );
}).toList();
```

## UI å˜åŒ–

### å½“å‰æ´»åŠ¨ç‰ˆæœ¬å¡ç‰‡
- âœ… ç‰ˆæœ¬å·ç«‹å³æ›´æ–°
- âœ… ä¸ä¼šæ˜¾ç¤º loading çŠ¶æ€
- âœ… å¹³æ»‘è¿‡æ¸¡ï¼Œæ— é—ªçƒ

### å·²å®‰è£…ç‰ˆæœ¬åˆ—è¡¨
- âœ… æ¿€æ´»çŠ¶æ€ç«‹å³æ›´æ–°
- âœ… æ—§ç‰ˆæœ¬çš„"å½“å‰ä½¿ç”¨"æ ‡ç­¾æ¶ˆå¤±
- âœ… æ–°ç‰ˆæœ¬æ˜¾ç¤º"å½“å‰ä½¿ç”¨"æ ‡ç­¾
- âœ… è¾¹æ¡†é¢œè‰²å’Œæ ·å¼ç«‹å³åˆ‡æ¢

### ç”¨æˆ·ä½“éªŒ
- âœ… åˆ‡æ¢é€Ÿåº¦å¿«ï¼ˆ1ç§’å†…å®Œæˆï¼‰
- âœ… æ— é¡µé¢é—ªçƒ
- âœ… æ—  loading çŠ¶æ€
- âœ… å³æ—¶åé¦ˆ

## ä½•æ—¶éœ€è¦å®Œæ•´åˆ·æ–°

ä»¥ä¸‹æƒ…å†µä»éœ€è¦è°ƒç”¨ `refresh()` å®Œæ•´åˆ·æ–°ï¼š

1. **å®‰è£…æ–°ç‰ˆæœ¬** - éœ€è¦é‡æ–°è·å–ç‰ˆæœ¬åˆ—è¡¨
2. **å¸è½½ç‰ˆæœ¬** - éœ€è¦æ›´æ–°ç‰ˆæœ¬åˆ—è¡¨
3. **åˆ‡æ¢ç‰ˆæœ¬ç®¡ç†å·¥å…·** - éœ€è¦é‡æ–°æ£€æµ‹æ‰€æœ‰ä¿¡æ¯
4. **å®‰è£…/æ›´æ–°åŒ…ç®¡ç†å™¨** - éœ€è¦æ›´æ–°åŒ…ç®¡ç†å™¨ç‰ˆæœ¬
5. **å®‰è£…/å¸è½½å…¨å±€åŒ…** - éœ€è¦æ›´æ–°å…¨å±€åŒ…åˆ—è¡¨

## å¯¹æ¯”æ€»ç»“

| æ“ä½œ | ä¹‹å‰ | ä¼˜åŒ–å | æå‡ |
|------|------|--------|------|
| åˆ‡æ¢ç‰ˆæœ¬ | åˆ·æ–°æ•´ä¸ªé¡µé¢ | åªæ›´æ–°ç‰ˆæœ¬ä¿¡æ¯ | å¿« 2-3 å€ |
| é¡µé¢é—ªçƒ | æœ‰ loading | æ— é—ªçƒ | âœ… |
| æ•°æ®åŠ è½½ | é‡æ–°åŠ è½½æ‰€æœ‰ | åªæ›´æ–°å¿…è¦æ•°æ® | âœ… |
| ç”¨æˆ·ä½“éªŒ | ä¸€èˆ¬ | ä¼˜ç§€ | âœ… |

## ä¿®æ”¹çš„æ–‡ä»¶

1. `lib/providers/node_providers.dart`
   - æ·»åŠ  `updateCurrentVersion` æ–¹æ³•

2. `lib/presentation/pages/node/node_page.dart`
   - ä¿®æ”¹ `_switchNodeVersion` æ–¹æ³•
   - ä» `refresh()` æ”¹ä¸º `updateCurrentVersion()`

## æµ‹è¯•éªŒè¯

1. âœ… ç‚¹å‡»ä¸åŒç‰ˆæœ¬åˆ‡æ¢
2. âœ… éªŒè¯å½“å‰ç‰ˆæœ¬å¡ç‰‡ç«‹å³æ›´æ–°
3. âœ… éªŒè¯ç‰ˆæœ¬åˆ—è¡¨æ¿€æ´»çŠ¶æ€ç«‹å³æ›´æ–°
4. âœ… éªŒè¯æ— é¡µé¢é—ªçƒ
5. âœ… éªŒè¯åˆ‡æ¢é€Ÿåº¦å¿«
6. âœ… éªŒè¯æˆåŠŸæç¤ºæ˜¾ç¤º

## æ€»ç»“

é€šè¿‡æ·»åŠ  `updateCurrentVersion` æ–¹æ³•ï¼Œå®ç°äº†ï¼š
- âš¡ æ›´å¿«çš„åˆ‡æ¢é€Ÿåº¦
- ğŸ¨ æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
- ğŸ’¾ æ›´å°‘çš„èµ„æºæ¶ˆè€—
- âœ¨ æ›´å¹³æ»‘çš„ UI è¿‡æ¸¡

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„"ç²¾ç¡®æ›´æ–°"ä¼˜åŒ–æ¡ˆä¾‹ï¼Œåªæ›´æ–°éœ€è¦å˜åŒ–çš„æ•°æ®ï¼Œè€Œä¸æ˜¯åˆ·æ–°æ•´ä¸ªçŠ¶æ€ã€‚
